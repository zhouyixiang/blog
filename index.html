<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="yixiang">
<meta property="og:url" content="http://yixiang.pw/index.html">
<meta property="og:site_name" content="yixiang">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="yixiang">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yixiang.pw/"/>





  <title>yixiang</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">yixiang</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yixiang.pw/2017/04/14/Learn-Words-While-Coding/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周意翔">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yixiang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/14/Learn-Words-While-Coding/" itemprop="url">代码中的单词</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-14T09:30:56+08:00">
                2017-04-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发/" itemprop="url" rel="index">
                    <span itemprop="name">开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="bail"><a href="#bail" class="headerlink" title="bail"></a>bail</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Tapable.prototype.applyPluginsBailResult = <span class="function"><span class="keyword">function</span> <span class="title">applyPluginsBailResult</span>(<span class="params">name</span>) </span>&#123;</div><div class="line">	<span class="keyword">if</span>(!<span class="keyword">this</span>._plugins[name]) <span class="keyword">return</span>;</div><div class="line">	<span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</div><div class="line">	<span class="keyword">var</span> plugins = <span class="keyword">this</span>._plugins[name];</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; plugins.length; i++) &#123;</div><div class="line">		<span class="keyword">var</span> result = plugins[i].apply(<span class="keyword">this</span>, args);</div><div class="line">		<span class="keyword">if</span>(<span class="keyword">typeof</span> result !== <span class="string">"undefined"</span>) &#123;</div><div class="line">			<span class="keyword">return</span> result;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;validate($request, [</div><div class="line">    <span class="string">'title'</span> =&gt; <span class="string">'bail|required|unique:posts|max:255'</span>,</div><div class="line">    <span class="string">'body'</span> =&gt; <span class="string">'required'</span>,</div><div class="line">]);</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yixiang.pw/2016/09/28/Linux-Init-System/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周意翔">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yixiang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/28/Linux-Init-System/" itemprop="url">Linux Init System</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-28T09:30:56+08:00">
                2016-09-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发/" itemprop="url" rel="index">
                    <span itemprop="name">开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天安装软件，整理了一些关于init system的资料。</p>
<h1 id="Linux-Init-System"><a href="#Linux-Init-System" class="headerlink" title="Linux Init System"></a>Linux Init System</h1><ul>
<li><p><a href="https://en.wikipedia.org/wiki/Operating_system_service_management" target="_blank" rel="external">Operating system service management (Wikipedia)</a></p>
<p>不同操作系统(Linux, Unix, macOS, Android, …)采用的系统服务管理技术。</p>
</li>
<li><p><a href="https://en.wikipedia.org/wiki/Init" target="_blank" rel="external">init (Wikipedia)</a></p>
<ul>
<li><p>Research Unix-style/BSD-style</p>
<p>系统初始化时执行脚本/etc/rc控制服务启动。支持site-specific /etc/rc.local以免修改/etc/rc。后来添加模块化支持，允许在/etc/rc.d文件夹中添加脚本。/etc/rc.d中的脚本如果有启动顺序要求，在脚本内用dependency tags显式指明，系统用rcorder脚本确定它们的排序。</p>
</li>
<li><p>SysV-style</p>
<p>添加runlevels概念，系统在不同runlevels间切换时，执行启动或结束各个服务管理脚本。默认runlevels在/etc/inittab中指定。</p>
</li>
</ul>
</li>
<li><p><a href="https://bbs.archlinux.org/viewtopic.php?id=47087" target="_blank" rel="external">BSD-style vs SysV-style</a></p>
<p>BSD:</p>
<ul>
<li>Startup scripts are generally kept in /etc/rc.d/</li>
<li>A small number of files (/etc/rc.sysinit, /etc/rc.local, etc.) control the startup process</li>
</ul>
<p>Sys V:</p>
<ul>
<li>Startup scripts are generally kept in /etc/init.d/</li>
<li>There are also a number of /etc/rcX.d/ directories – one for every run-level (i.e. X represents 0 through 6 and S, so, 8 altogether)</li>
<li>The contents of each /etc/rcX.d/ directory is a collection of soft-links to scripts in /etc/init.d/</li>
<li>Each soft-link in a specific /etc/rcX.d/ directory is named so it will execute in the order of it’s alphabetical relationship to the other soft-links</li>
</ul>
<p>可以看到BSD和SysV都可以将服务启动脚本放到/etc/rc.d文件夹下。SysV将脚本软连接到不同runlevel对应的/etc/rcX.d/文件中，启动顺序通过软连接文件名确定，而BSD的启动顺序在脚本中指定。</p>
<blockquote>
<p>Example (ls -1 /etc/rc3.d/):</p>
<p>S05vbesave  &lt;– execs first</p>
<p>S10acpid</p>
<p>S10sysklogd</p>
<p>S10xserver-xorg-input-wacom</p>
<p>S11klogd</p>
<p>S12dbus</p>
<p>S12hal</p>
<p>…</p>
<p>S98usplash</p>
<p>S99acpi-support</p>
<p>S99laptop-mode</p>
<p>S99rc.local</p>
<p>S99rmnologin  &lt;– execs last</p>
<p>This example was actually 39 lines long – and just represents run-level #3.  In addition, /etc/rc.local executes after the target run-level is finished doing init.<br>So, given Sys V’s complex hierarchy – spanning 8 run-levels by an average of N-number of daemons – you can probably guess why so many people rave about Arch’s BSD-style init schema ;-)</p>
</blockquote>
</li>
<li><p><a href="http://centos-vn.blogspot.jp/2014/06/daemon-showdown-upstart-vs-runit-vs.html" target="_blank" rel="external">Upstart vs. Runit vs. Systemd vs. Circus vs. God</a></p>
<p>Where Upstart uses ptrace to watch the forking, systemd runs each daemon in a control group (requires Linux 2.6.24 or newer) from which it can not escape with any amount of forking. This allows easy resource limiting , both for forking and non-forking daemons, since control groups were made for this sort of thing.</p>
</li>
<li><p><a href="http://searchenterpriselinux.techtarget.com/tip/RHEL-6-ditches-System-V-init-for-Upstart-What-Linux-admins-need-to-know" target="_blank" rel="external">RHEL 6 ditches System V init for Upstart</a></p>
</li>
<li><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/chap-Managing_Services_with_systemd.html" target="_blank" rel="external">RHEL 7 Systemd </a></li>
<li><a href="http://linuxcommand.org/man_pages/chkconfig8.html" target="_blank" rel="external">chkconfig</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yixiang.pw/2016/09/28/Laravel-MessageBag/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周意翔">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yixiang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/28/Laravel-MessageBag/" itemprop="url">Laravel MessageBag与Validation</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-28T09:30:56+08:00">
                2016-09-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发/" itemprop="url" rel="index">
                    <span itemprop="name">开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Message-Bag"><a href="#Message-Bag" class="headerlink" title="Message Bag"></a>Message Bag</h1><h2 id="Message-Bag数据结构"><a href="#Message-Bag数据结构" class="headerlink" title="Message Bag数据结构"></a>Message Bag数据结构</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">  <span class="string">'key1'</span> =&gt; [</div><div class="line">    <span class="string">'message 1'</span>,</div><div class="line">    <span class="string">'message 2'</span>,</div><div class="line">  ],</div><div class="line">  <span class="string">'key2'</span> =&gt; [</div><div class="line">    <span class="string">'message 1'</span>,</div><div class="line">    <span class="string">'message 2'</span>,</div><div class="line">  ],</div><div class="line">]</div></pre></td></tr></table></figure>
<h2 id="Message-Bag读取接口"><a href="#Message-Bag读取接口" class="headerlink" title="Message Bag读取接口"></a>Message Bag读取接口</h2><p>format: “:key的消息是:message”</p>
<p>返回一个array，和message bag内部存储结构相同。消息按照format参数格式化。format默认格式是“:message”，也就是不变。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">  <span class="string">'key1'</span> =&gt; [</div><div class="line">    <span class="string">'key1的消息是message 1'</span>,</div><div class="line">    ...</div><div class="line">  ],</div><div class="line">  ...</div><div class="line">]</div></pre></td></tr></table></figure></p>
<h1 id="Validation"><a href="#Validation" class="headerlink" title="Validation"></a>Validation</h1><p>Laravel的验证框架有下面几个构件：</p>
<ul>
<li>MessageBag 用于存储验证失败信息</li>
<li>Rule 验证规则</li>
<li>Message Rule验证失败的错误消息</li>
<li>Data 验证的数据</li>
</ul>
<h1 id="Validator-MessageBag生成过程"><a href="#Validator-MessageBag生成过程" class="headerlink" title="Validator MessageBag生成过程"></a>Validator MessageBag生成过程</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$validator = app(Factory::class)-&gt;make([</div><div class="line">  <span class="string">'attr1'</span> =&gt; <span class="string">'some value'</span>,</div><div class="line">  <span class="string">'attr2'</span> =&gt; <span class="string">'some value'</span>,</div><div class="line">], [</div><div class="line">  <span class="string">'rule1'</span> =&gt; <span class="string">':attribute不满足:rule1Replacer'</span>,</div><div class="line">  <span class="string">'rule2'</span> =&gt; <span class="string">':attribute不满足:rule2Replacer'</span>,</div><div class="line">], [</div><div class="line">  <span class="string">'attr1'</span> =&gt; <span class="string">'rule1|rule2|rule3'</span>,</div><div class="line">  <span class="string">'attr2'</span> =&gt; <span class="string">'rule1|rule2|rule3'</span>,</div><div class="line">]);</div></pre></td></tr></table></figure>
<p>MessageBag的format只需要/支持:key和:message两个占位符，Validator自己根据规则扩展了占位符，在Validator内部自己负责替换。<br>Validator内部的MessageBag以校验的数据attribute为key。当某个属性的某条验证规则（例如: “min:6”）失败时，会提取出该条验证规则对应的message，然后替换掉message中的占位符（例如:attribute, :min），将替换后的消息存放到MessageBag中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">  <span class="string">'attribute1'</span> =&gt; [</div><div class="line">    <span class="string">'key1的消息是message 1'</span>,</div><div class="line">    <span class="string">'key1的消息是message 2'</span>,</div><div class="line">  ],</div><div class="line">  <span class="string">'attribute1'</span> =&gt; [</div><div class="line">    <span class="string">'key2的消息是message 1'</span>,</div><div class="line">    <span class="string">'key2的消息是message 2'</span>,</div><div class="line">  ],</div><div class="line">]</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yixiang.pw/2016/09/25/遇到一个Laravel-Dingo-API坑/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周意翔">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yixiang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/25/遇到一个Laravel-Dingo-API坑/" itemprop="url">Laravel + Dingo API 遇到一个小坑</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-25T09:30:56+08:00">
                2016-09-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发/" itemprop="url" rel="index">
                    <span itemprop="name">开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>使用Laravel和Dingo API包写一个多租户系统，采用了Multi tenants share a single database的方式，在租户相关的表中有租户ID列。实现了一个租户相关的Global Scope，在需要限定租户的地方进行调用。</p>
<p>在API Controller中，如果大多数接口方法都要使用这个Global Scope，我就把它在constructor中调用了，能够省事，不过这里有个潜在的问题：</p>
<p>Laravel在构造路由的时候会创建一遍Controller，因此会添加上这些Global Scope。本来在API Controller方法中，我只希望该Controller按照构造函数中的方式添加Global Scope，但实际上其它API Controller中的constructor也被调用过了，因此可能在Eloquent中添加了设想之外的全局查询约束。</p>
<p>这个问题在执行Console命令的时候同样存在。虽然直观感觉上，Controller中的代码不应该影响到Console命令，但根据下面的Stack trace可以看出，执行Console命令在Framework Bootstrap时Dingo会构造Controller实例搜集路由配置，这个…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">#0 example/app/Modules/Course/Api/Controllers/CourseController.php(40): App\\Models\\HospitalScope-&gt;__construct(NULL)</div><div class="line">#1 [internal function]: App\\Modules\\Course\\Api\\Controllers\\CourseController-&gt;__construct()</div><div class="line">#2 example/vendor/laravel/framework/src/Illuminate/Container/Container.php(779): ReflectionClass-&gt;newInstanceArgs(Array)</div><div class="line">#3 example/vendor/laravel/framework/src/Illuminate/Container/Container.php(629): Illuminate\\Container\\Container-&gt;build(&apos;App\\\\Modules\\\\Cou...&apos;, Array)</div><div class="line">#4 example/vendor/laravel/framework/src/Illuminate/Foundation/Application.php(709): Illuminate\\Container\\Container-&gt;make(&apos;App\\\\Modules\\\\Cou...&apos;, Array)</div><div class="line">#5 example/vendor/dingo/api/src/Routing/Route.php(318): Illuminate\\Foundation\\Application-&gt;make(&apos;App\\\\Modules\\\\Cou...&apos;)</div><div class="line">#6 example/vendor/dingo/api/src/Routing/Route.php(180): Dingo\\Api\\Routing\\Route-&gt;makeControllerInstance()</div><div class="line">#7 example/vendor/dingo/api/src/Routing/Route.php(163): Dingo\\Api\\Routing\\Route-&gt;mergeControllerProperties()</div><div class="line">#8 example/vendor/dingo/api/src/Routing/Route.php(142): Dingo\\Api\\Routing\\Route-&gt;setupRouteProperties(Object(Illuminate\\Http\\Request), Object(Illuminate\\Routing\\Route))</div><div class="line">#9 example/vendor/dingo/api/src/Routing/Router.php(652): Dingo\\Api\\Routing\\Route-&gt;__construct(Object(Dingo\\Api\\Routing\\Adapter\\Laravel), Object(Illuminate\\Foundation\\Application), Object(Illuminate\\Http\\Request), Object(Illuminate\\Routing\\Route))</div><div class="line">#10 example/vendor/dingo/api/src/Routing/Router.php(714): Dingo\\Api\\Routing\\Router-&gt;createRoute(Object(Illuminate\\Routing\\Route))</div><div class="line">#11 example/vendor/dingo/api/src/Routing/Router.php(744): Dingo\\Api\\Routing\\Router-&gt;getRoutes()</div><div class="line">#12 example/bootstrap/cache/routes.php(17): Dingo\\Api\\Routing\\Router-&gt;setAdapterRoutes(Array)</div><div class="line">#13 example/vendor/laravel/framework/src/Illuminate/Foundation/Support/Providers/RouteServiceProvider.php(59): require(&apos;/var/www/vhosts...&apos;)</div><div class="line">#14 [internal function]: Illuminate\\Foundation\\Support\\Providers\\RouteServiceProvider-&gt;Illuminate\\Foundation\\Support\\Providers\\&#123;closure&#125;(Object(Illuminate\\Foundation\\Application))</div><div class="line">#15 example/vendor/laravel/framework/src/Illuminate/Foundation/Application.php(808): call_user_func(Object(Closure), Object(Illuminate\\Foundation\\Application))</div><div class="line">#16 example/vendor/laravel/framework/src/Illuminate/Foundation/Application.php(757): Illuminate\\Foundation\\Application-&gt;fireAppCallbacks(Array)</div><div class="line">#17 example/vendor/laravel/framework/src/Illuminate/Foundation/Bootstrap/BootProviders.php(17): Illuminate\\Foundation\\Application-&gt;boot()</div><div class="line">#18 example/vendor/laravel/framework/src/Illuminate/Foundation/Application.php(203): Illuminate\\Foundation\\Bootstrap\\BootProviders-&gt;bootstrap(Object(Illuminate\\Foundation\\Application))</div><div class="line">#19 example/vendor/laravel/framework/src/Illuminate/Foundation/Console/Kernel.php(262): Illuminate\\Foundation\\Application-&gt;bootstrapWith(Array)</div><div class="line">#20 example/vendor/laravel/framework/src/Illuminate/Foundation/Console/Kernel.php(114): Illuminate\\Foundation\\Console\\Kernel-&gt;bootstrap()</div><div class="line">#21 example/artisan(35): Illuminate\\Foundation\\Console\\Kernel-&gt;handle(Object(Symfony\\Component\\Console\\Input\\ArgvInput), Object(Symfony\\Component\\Console\\Output\\ConsoleOutput))</div><div class="line">#22 &#123;main&#125;&quot;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yixiang.pw/2016/06/01/CSS-Visual-Fomatting-Model/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周意翔">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yixiang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/01/CSS-Visual-Fomatting-Model/" itemprop="url">CSS Visual Formatting Model</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-06-01T21:53:49+08:00">
                2016-06-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发/" itemprop="url" rel="index">
                    <span itemprop="name">开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<h1 id="CSS-Visual-Formatting-Model"><a href="#CSS-Visual-Formatting-Model" class="headerlink" title="CSS Visual Formatting Model"></a>CSS Visual Formatting Model</h1><h2 id="Containing-Block"><a href="#Containing-Block" class="headerlink" title="Containing Block"></a>Containing Block</h2><p>这个block也是个box，box是其内嵌box的containing block。</p>
<blockquote>
<p>In general, generated boxes act as containing blocks for descendant boxes; we say that a box “establishes” the containing block for its descendants.<br>Each box is given a position with respect to its containing block, but it is not confined by this containing block; it may overflow.</p>
</blockquote>
<h2 id="Viewport"><a href="#Viewport" class="headerlink" title="Viewport"></a>Viewport</h2><p>页面渲染到canvas上面，用户通过浏览器提供的viewport和页面交互。 Viewport可能比canvas小，浏览器因此需要提供滚动机制。</p>
<h2 id="Elment-Box"><a href="#Elment-Box" class="headerlink" title="Elment, Box"></a>Elment, Box</h2><p>HTML Element首先会映射成为各种类型的box，页面排版是对box的排版。</p>
<ul>
<li>一个Element可能生成多个box，</li>
<li>有的box类似段落的一段，</li>
<li>有的box类似段落的一行，</li>
<li>有的box类似行内的一个字符</li>
</ul>
<h2 id="Block-level-Box-Block-level-element-Block-container-box-Block-box"><a href="#Block-level-Box-Block-level-element-Block-container-box-Block-box" class="headerlink" title="Block-level Box, Block-level element, Block container box, Block box"></a>Block-level Box, Block-level element, Block container box, Block box</h2><h3 id="Block-level-Box"><a href="#Block-level-Box" class="headerlink" title="Block-level Box"></a>Block-level Box</h3><p>从该Box在Container中的显示形式来看。<br>Block-level Box参与BFC，也就是说这些Box是按照垂直方向依次摆放的。</p>
<h3 id="Block-level-element"><a href="#Block-level-element" class="headerlink" title="Block-level element"></a>Block-level element</h3><p>Block-level element (BLE)可能产生多个box，但每个BLE会生成一个principal block-level box。这个主box会包含BLE生成的其它box，这些额外的box会相对于主box进行布局。主box代表整个BLE参与到any positioning scheme。这几个display属性会让元素变成BLE: ‘block’, ‘list-item’, ‘table’.</p>
<h3 id="Block-container-box-Block-box"><a href="#Block-container-box-Block-box" class="headerlink" title="Block container box, Block box"></a>Block container box, Block box</h3><p>从该Box包含的下级Box来看。</p>
<p>Block container box的定义有点绕。把标准里面的描述顺序重排一下，把描述分成两类：一类针对该box内部的子box，另一类针对该box对外界。</p>
<blockquote>
<p>A block container box either contains only block-level boxes or establishes an inline formatting context and thus contains only inline-level boxes.</p>
</blockquote>
<p>上面说明Block container box要么只包含Block-level boxes，要么只包含inline-level boxes，后面这种情况，还专门说建立了一个inline formatting context。那么前一种情况为什么不提会不会建立BFC呢？</p>
<blockquote>
<p>Not all block container boxes are block-level boxes: non-replaced inline blocks and non-replaced table cells are block containers but not block-level boxes.</p>
<p>Except for table boxes and replaced elements, a block-level box is also a block container box.</p>
</blockquote>
<p>上面两段说明inline-block和table cells虽然不是bock-level boxes，但也是block container box。而block-level box也不一定都是block container box。总而言之，block container box主要是看它内部能容纳什么。</p>
<blockquote>
<p>Block-level boxes that are also block containers are called block boxes.</p>
</blockquote>
<p>block boxes的定义。</p>
<h2 id="Block-Formatting-Context"><a href="#Block-Formatting-Context" class="headerlink" title="Block Formatting Context"></a>Block Formatting Context</h2><p>BFC下面的（一级）box都是block-level box (可能是根据子block-level element生成的，或隐式生成的)。</p>
<blockquote>
<p>In a block formatting context, boxes are laid out one after the other, vertically, beginning at the top of a containing block. The vertical distance between two sibling boxes is determined by the ‘margin’ properties. Vertical margins between adjacent block-level boxes in a block formatting context collapse.</p>
</blockquote>
<p>在一个BFC里面，box的左边界和BFC的左边界接触 （或右边）。</p>
<blockquote>
<p>In a block formatting context, each box’s left outer edge touches the left edge of the containing block (for right-to-left formatting, right edges touch). This is true even in the presence of floats (although a box’s line boxes may shrink due to the floats), unless the box establishes a new block formatting context (in which case the box itself may become narrower due to the floats).</p>
</blockquote>
<p>当有Float元素存在时，可以把block-level box进一步看成一堆的line box，它们总是尽量往左靠齐到BFC边界，除非遇到Float。</p>
<p>例子：对于下面的HTML结构，<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">""</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"b1"</span>&gt;</span></div><div class="line">    ...</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"b2"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"c1"</span>&gt;</span></div><div class="line">      ...</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"c2"</span>&gt;</span></div><div class="line">      ...</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="selector-class">.b1</span> &#123;</div><div class="line">  <span class="attribute">border</span>: <span class="number">10px</span> red solid;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-class">.b2</span> &#123;</div><div class="line">  <span class="attribute">border</span>: <span class="number">10px</span> green solid;</div><div class="line">  //width: 300px;</div><div class="line">  <span class="selector-tag">overflow</span>: <span class="selector-tag">hidden</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-class">.c1</span> &#123;</div><div class="line">  <span class="attribute">border</span>: <span class="number">10px</span> blue solid;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-class">.c2</span> &#123;</div><div class="line">  <span class="attribute">border</span>: <span class="number">10px</span> black solid;</div><div class="line">&#125;</div><div class="line"><span class="selector-tag">img</span> &#123;</div><div class="line">  <span class="attribute">float</span>: left;</div><div class="line">  //opacity: 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当.b2不使用overflow:hidden建立新的BFC时，布局如下：</p>
<p>!{bfc}[./img/bfc.png “”]</p>
<p>当.b2使用overflow:hidden建立新的BFC时，布局如下：</p>
<p>!{bfc}[./img/new_bfc.png “”]</p>
<p>另外可以注释掉overflow，设置.b2的width小于图片的宽度，这时.b2的内容看上去像是换行开始布局，因为它的宽度覆盖不了图片，因此图片覆盖的部分时空白的。</p>
<p>!{bfc}[./img/small_width.png “”]</p>
<p>可以通过下面的JsFindle去测试这些情况：￼<br><a href="https://jsfiddle.net/hostapd/bhuqqtq9/" target="_blank" rel="external">https://jsfiddle.net/hostapd/bhuqqtq9/</a></p>
<h2 id="如何建立BFC？"><a href="#如何建立BFC？" class="headerlink" title="如何建立BFC？"></a>如何建立BFC？</h2><blockquote>
<p>Floats, absolutely positioned elements, block containers (such as inline-blocks, table-cells, and table-captions) that are not block boxes, and block boxes with ‘overflow’ other than ‘visible’ (except when that value has been propagated to the viewport) establish new block formatting contexts for their contents.</p>
</blockquote>
<ul>
<li>float元素</li>
<li>绝对定位元素</li>
<li>block containers &amp;&amp; !block level box</li>
<li>overflow != visible</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yixiang.pw/2014/12/21/Laravel源码分析-Container/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周意翔">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yixiang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/12/21/Laravel源码分析-Container/" itemprop="url">Laravel源码分析 - Container</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-12-21T21:26:55+08:00">
                2014-12-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发/" itemprop="url" rel="index">
                    <span itemprop="name">开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作为SOLID基本原则之一，DI也被Laravel采纳，用于解耦框架内大量的组件。关于依赖注入，可以阅读<a href="https://en.wikipedia.org/wiki/Dependency_injection" target="_blank" rel="external">维基百科上的介绍和示例</a>，这是理解Laravel框容器的基础，按照wikipedia上的介绍，DI涉及到四个基本组件：</p>
<ul>
<li>Service Object</li>
<li>Client Object depending on the service;</li>
<li>Interface the client uses to communicate with the service;</li>
<li>Injector (assembler, provider, container, factory, or spring)</li>
</ul>
<p>Laravel框架组件管理的基础是DI，本文基于Laravel 4.2的Container（也就是上面的Injector）实现进行分析。 Laravel的Container实现位于src\Illuminate\Container\Container.php文件中，可以看到文件中有很多高频使用的变量命名，包括：</p>
<ul>
<li>abstract,</li>
<li>concrete,</li>
<li>alias</li>
</ul>
<p>这些变量名反映了Laravel容器里面的一些基本概念，下面对它们做一些说明。了解这些概念之后，容器的源代码理解起来会简单一些。</p>
<h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><p>组件对应DI中的Service Object，是向外部提供某种服务的对象。容器负责Service Object的产生，Service Object由Service定义，Laravel框架中有很多提供不同功能的Service例子，如提供认证服务的Service，提供Cache功能的Service，提供Mail功能的Service等等。</p>
<p>这些Service的功能由一些类或者接口定义（例如Auth Service的定义在Illuminate\Auth\AuthManager中），他们被注册后，容器负责其对象的实例化。注册接口由容器的bind函数定义，可以参看后面“Service Object产生”一节。</p>
<h1 id="Service名-abstract"><a href="#Service名-abstract" class="headerlink" title="Service名 (abstract)"></a>Service名 (abstract)</h1><p>容器里的Service都可以通过名字访问。例如，要产生一个提供认证服务的Service Object，可以调用Container的make方法，传入字符串’auth’，让容器给我们返回一个认证组件的实例。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$authServiceObject = app()-&gt;make(‘auth’)</div></pre></td></tr></table></figure>
<p>Laravel框架本身提供了很多Service，Laravel对这些Service进行了命名，例如: ‘auth’, ‘cache’, ‘config’, ‘cookie’, 等等。</p>
<p>Laravel本身按照模块化的方式对代码进行组织，每个模块都提供了一些Service，可以通过查看各个模块中的ServiceProvider代码看注册了哪些Service，及其对应的Service名。另外，通过src\Illuminate\Foundation\Application.php文件中的registerCoreContainerAliases方法，也可以看到一个service名字列表。 </p>
<p>对于Service命名的原则，通过代码可以看到，Laravel选择的是简洁明了，像’auth’这样的名字。由于Laravel容器还可以根据类型产生Service Object，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$authServiceObject = app()-&gt;make(<span class="string">'Illuminate\Auth\AuthManager'</span>)</div></pre></td></tr></table></figure>
<p>因此容器提供了通过多个名字引用Service Object的机制，这就是别名。</p>
<h1 id="Service别名-alias"><a href="#Service别名-alias" class="headerlink" title="Service别名 (alias)"></a>Service别名 (alias)</h1><p>Laravel中，每个Service可以有多个名字，其中一个被称为abstract名，其余的则称为alias。容器通过abstract名知道如何产生Service Object。对于alias名称，容器首先查找alias对应的abstract，然后找到产生Service Object的方式。 </p>
<p>Container中有一个$aliases字段，包含了alias到abstract名字的映射关系。容器使用者可以通过下面的函数注册别名。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">alias</span><span class="params">($abstract, $alias)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;aliases[$alias] = $abstract;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Service-Object的产生-concrete"><a href="#Service-Object的产生-concrete" class="headerlink" title="Service Object的产生 (concrete)"></a>Service Object的产生 (concrete)</h1><p>调用者向容器注册Service的同时提供了产生Service Object的办法。最基本的注册接口如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span><span class="params">($abstract, $concrete = null, $shared = false)</span></span></div></pre></td></tr></table></figure>
<p>其中abstract是Service名字，$concrete指定了Service Object的产生方式，可以是一个Closure对象，string或者null对象，对于后两种，在Container内部最终也会转换成产生Service Object的Closure。 注册之后，容器使用者就可以通过make接口产生Service Object，接口签名如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($abstract, $parameters = array<span class="params">()</span>)</span></span></div></pre></td></tr></table></figure>
<p>make函数的参数名字为abstract，其值可以是Service名或者别名，在make函数内部都会转换成为Service名(abstract)，然后找到其对应的Service Object产生方式生成Object。 make函数调用了一个函数getAlias：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($abstract, $parameters = array<span class="params">()</span>)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    $abstract = <span class="keyword">$this</span>-&gt;getAlias($abstract);</div></pre></td></tr></table></figure>
<p>这个getAlias函数命名很让人很容易产生混淆，因为其功能实际上是通过aliases数组查询alias对应的abstract名。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAlias</span><span class="params">($abstract)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;aliases[$abstract]) ? <span class="keyword">$this</span>-&gt;aliases[$abstract] : $abstract;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yixiang.pw/2014/10/26/判断/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周意翔">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yixiang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/10/26/判断/" itemprop="url">判断</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-10-26T16:11:58+08:00">
                2014-10-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生活/" itemprop="url" rel="index">
                    <span itemprop="name">生活</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上学的时学到一种分析方式：将被研究的东西抽象成一个黑盒子系统，从系统输入输入和输出的角度进行分析。这个方法拿来思考人的行为也比较有意思。 </p>
<p>三国演义曹操败走华容道常让我想到这里。曹操在途中于一大一小两条道路选择，小路有烟，大路无动静。曹操面对这两条路决策，最后选择了小路。书中，曹操分析的过程如下：</p>
<blockquote>
<p>操曰：“岂不闻兵书有云：虚则实之，实则虚之。诸葛亮多谋，故使人于山僻烧烟，使我军不敢从这条山路走，他却伏兵于大路等着。吾料已定，偏不教中他计！”诸将皆曰：“丞相妙算，人不可及。”</p>
</blockquote>
<p>如果不描述曹操的分析过程，只看曹操选择的道路，如何判断曹操是否神机妙算呢？我们天天接触到他人的言行，通常情况下无法了解到做出引发这些行为的内在驱动，但我们却又习惯根据这些言行推测他人。</p>
<p>回到曹操的决策上，去掉原文中关于曹操自己的解释，那么他本身可能是下面几种人：</p>
<ul>
<li>一般人</li>
</ul>
<p>曹操这么考虑：小路有烟就有人，因此走大路安全些</p>
<ul>
<li>聪明人</li>
</ul>
<p>曹操这么考虑：一般人会认为‘小路有烟就有人，因此走大路安全些’，诸葛亮以为我是一般人，因此认为我会走大路，所以我选择小路更安全。</p>
<ul>
<li>非常聪明的人</li>
</ul>
<p>曹操这么考虑：聪明人会想: 一般人会认为[小路有烟就有人，因此走大路安全些]，诸葛亮以为我是一般人，因此认为我会走大路，所以我选择小路更安全。诸葛亮认为我是聪明人，因此断定我会选择小路，所以我应该选择大路。</p>
<ul>
<li>非常非常聪明的人</li>
</ul>
<p>… </p>
<p>这个过程可以一直推演下去，不管曹操选择哪条路，他都可能是一般人，聪明人，非常聪明的人，…。 </p>
<p>而我们（如诸葛亮）作为外部观察者，根据他的选择情况，最终会给他贴上何种标签呢？这依赖于我们能够理解的不同聪明程度的人的思考方式，以及我们多少带有随机意味的判断。从这次单次的决策结果上，很难判定曹操是否聪明及其聪明程度。如果曹操是非常聪明的人，而你认为他只是聪明人，那么下次交锋之时，你的决策就可能让你一败涂地。 </p>
<p>通过某人的一次行为确实很难对他评判，我们却在很多时候就这么干着。评判一个人之后，会影响到我们与其交互的行为方式，虽很少像小说中那么性命攸关，但终归有影响，值得我们思考。</p>
<p>一个简单地过程，比如上网看到某人的某种言论，然后认为此人不好，然后语言攻击。 人本身的复杂，往往让自己都不能对自己进行评定，更何况其他人。</p>
<p>然而生活经验还是能够告诉我们，身边谁善良，谁狡猾，谁好谁坏。这些评价往往是在相互长时间接触下做出的。如果机械一点，将人看成系统，我们掌握了某个人大量的输入（某种环境下的某些事件等等）、输出（该人对外界做出的反应）数据之后，可以对这个系统进行一些建模和参数估计，最终得到一个模型，之后便可以用该模型进行行为预测。 </p>
<p>这种想法没有太多人情味，将人看做机器一般，但这个过程和现实生活却是契合的。我们看到一个人经常做正能量的事之后，我们便倾向于认为此人以后还是会很正能量；看到一个人做坏事之后，便倾向于认为这个坏人以后也干不出什么好事。我们在自己的内心深处给周围的人建立了一个又一个的模型，只是这些模型不像通过系统方法做出的那么机械和固定。</p>
<p>以系统的方法(机械化地)分析一个人，虽然更像是书呆子毫无生趣的行为，倒也有一个好处：系统最终按照某种模型得出一组参数（当然这些参数随着时间的增长会做出调整），这些参数成为每个人的特征，它们的取值是具有更多变性的，而不仅仅停留到好与坏的二元判断。</p>
<p>一个做出很多好事的人，也只是在某些环境下的输出是好的，然而总可能存在某种环境输出不好的行为。生活中，对于“坏人”我们固然避而远之，对“好人”也不要忘记警惕。如果“坏行为”从你认为的“好人”输出了，不用叹息扼腕，你知道，在他固有的模型下输出这种行为本来就是有可能的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yixiang.pw/2014/10/25/SSH隧道/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周意翔">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yixiang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/10/25/SSH隧道/" itemprop="url">SSH隧道</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-10-25T17:56:56+08:00">
                2014-10-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发/" itemprop="url" rel="index">
                    <span itemprop="name">开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>有时我们希望能够让别人能够远程访问在我们内网里面的某个网络服务。 例如在Web开发时，我们做了一些功能之后，希望让客户先看看，如果客户在很远的地方，那么我们只能将Web应用先部署到公网上，然后让他访问。</p>
<p>部署Web应用有时候是一件麻烦的事情：需要配置Web Server，数据库等等相关的组件，有时会很多。</p>
<p>或者又例如，你基于某个平台的API进行开发测试，比如alipay的API，或者微信API。这些平台需要把请求发送到由你指定的URL，当然这些URL必须是公网的。但如果总是将代码部署到公网服务器上再进行测试，效率非常低。</p>
<h1 id="SSH-Tunnel-Port-Forwarding"><a href="#SSH-Tunnel-Port-Forwarding" class="headerlink" title="SSH Tunnel Port Forwarding"></a>SSH Tunnel Port Forwarding</h1><p>有一个依赖SSH隧道的解决办法，前提需要你有一台公网上的服务器，并且服务器能够通过SSH连接。 </p>
<p>假如我们有下面这样的需求： 一个开发者在家里进行网站开发，他的同事在公司里面想看看他的进展，公司在公网上有一台服务器。开发者当然可以将应用部署到服务器上让同事看，不过我们有更简单地办法。</p>
<p>图片</p>
<p>如果开发者的Web应用在自己开发及其上监听8000端口，他可以使用下面的命令（前提需要开启SSH的相应功能，可参考文末链接进行设置）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh -v -R 0.0.0.0:public_server_port:0.0.0.0:8000 username@server</div></pre></td></tr></table></figure>
<p>这样便建立了一条开发者机器到公网Server的一条SSH隧道，并将对公网server public_server_port的访问转发到开发者机器的8000端口。之后，他的同事在公司里面直接用浏览器访问公网Server上的这个端口就行了。是不是很方便？ </p>
<h1 id="Linux-Firewall-Settings"><a href="#Linux-Firewall-Settings" class="headerlink" title="Linux Firewall Settings"></a>Linux Firewall Settings</h1><p>正常情况下，可能还需要对防火墙进行一些额外设置，毕竟我们在Server上开了一个新的端口。 使用CentOS 6.5作为中间服务器设置过程 </p>
<ol>
<li><p>打开CentOS 6.5 SSH配置文件中的/etc/ssh/sshd_config GatewayPort选项。 </p>
</li>
<li><p>重启ssh服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service sshd restart</div></pre></td></tr></table></figure>
</li>
<li><p>选择centos 6.5上使用的端口，例如8999，需要开启8999端口的防火墙设置</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">iptables --line -vnL</div><div class="line"><span class="meta">#</span>index的值根据iptables --line -vnL的输出确定</div><div class="line">iptables -I INPUT index -p tcp --dport 8999 -m state --state NEW,ESTABLISHED -j ACCEPT</div></pre></td></tr></table></figure>
<ol>
<li>保存防火墙设置并重启防火墙</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">service iptables save</div><div class="line">service iptables restart</div></pre></td></tr></table></figure>
<p>如需删除某条规则：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -D INPUT index</div></pre></td></tr></table></figure>
<ol>
<li>在local环境下，使用SSH建立tunnel</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh -v -R 0.0.0.0:8999:0.0.0.0:8000 username@server</div></pre></td></tr></table></figure>
<ol>
<li>Done </li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><p>SSH tunnel</p>
<ul>
<li><p><a href="http://blog.trackets.com/2014/05/17/ssh-tunnel-local-and-remote-port-forwarding-explained-with-examples.html" target="_blank" rel="external">http://blog.trackets.com/2014/05/17/ssh-tunnel-local-and-remote-port-forwarding-explained-with-examples.html</a></p>
</li>
<li><p><a href="http://www.noah.org/wiki/SSH_tunnel" target="_blank" rel="external">http://www.noah.org/wiki/SSH_tunnel</a> </p>
</li>
</ul>
</li>
<li><p>Iptables设置 </p>
<ul>
<li><a href="http://www.binarytides.com/open-http-port-iptables-centos/" target="_blank" rel="external">http://www.binarytides.com/open-http-port-iptables-centos/</a></li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yixiang.pw/2014/10/19/挪威的森林/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周意翔">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yixiang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/10/19/挪威的森林/" itemprop="url">挪威的森林</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-10-19T17:00:52+08:00">
                2014-10-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生活/" itemprop="url" rel="index">
                    <span itemprop="name">生活</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>以前很少看小说，一方面是觉得效率低，很多小说已经有电影或者电视的呈现方式，通过这些方式可能花更短的时间去了解这些作品。这个想法存在很长了时间，倒不是觉得时间应该花到更具价值的时事情上面，我知道这不是浪费时间，况且什么又是更有价值的事情呢？另外一个更重要是心理的原因，总觉得很多人都在做某件事情的时候，自己就不太想去做。这种心态影响了很多事，到最近几年才慢慢改变，开始以补缺的心态去了解小说，动漫等等之前认为“非正”的世界。看《挪威的森林》也是因为想做这种转变，读起来很畅快，快完的时候才想起看一下读了多少。</p>
<h1 id="性"><a href="#性" class="headerlink" title="性"></a>性</h1><p>小说里面很多关于性方面的描写，但毕竟不是色情小说，不专注于那些细节。性是很多小说不可或缺的部分，就像上学时看过的部分《白鹿原》。这很吸引人，我想至少对年轻人是这样，或者再缩小点范围，年轻男人。大学时候关于成人电影流行的说法：没看过的人大学是不完整的，应该很好地说明了这种吸引力。</p>
<p>小说里渡边和直子，绿子，玲子都存在性关系，渡边爱着直子的同时，和永泽到外面找女人一夜情，和绿子搞在一起。单看这些情节，不专一的行为和爱情交织在一起，让人有些难受。然而小说的描写，使得这些事情都很自然地发生。这不是理想爱情的小说，所有人都因为缺陷变得真实。书里面人们在一起，因为冲动发生了性，因为孤独产生了彼此间的感情。</p>
<p>小说里的人物，在谈论性时非常直接，没有想象中那么委婉。这些人对性和情感也能相对分开，以至他们在知道爱人和其他人发生关系时也没有很大的反应，反而很多时候从现实的角度去理解。小说整个基调虽然不轻松，但也许是这种理解，却没有让人感到纠结吧。这些事情在我们的生活中会成为隐瞒、欺骗、怨恨和暴力的根源，小说里却没有。</p>
<h1 id="坦诚"><a href="#坦诚" class="headerlink" title="坦诚"></a>坦诚</h1><p>渡边和绿子，都在拥有爱人的同时和其他人搞在一起。渡边只是一个小人物，孤僻，没钱，绿子说话粗鄙，永泽花心。。。但这些人物在小说中都很真诚，都能坦诚自己的缺点而不欺骗，能够坦白龌蹉的想法而不隐瞒。相比之下，那些带头罢课搞革命的学生头目又抢先回去上课让人觉得虚伪恶心，虽然小说对这些人的描述并不多。</p>
<h1 id="孤独"><a href="#孤独" class="headerlink" title="孤独"></a>孤独</h1><p>渡边在孤独的时候和直子慢慢成了恋人，同样是在孤独的时候和绿子慢慢成了恋人。都是一个渐渐的过程，其实没有什么标志性的时间点，他和直子上床的时间不是，和绿子在阳台接吻的时候也不是。孤独让他们先后融入了彼此的生活，当直子死后，渡边四处流浪，心中的痛楚我想除了直子的死本身外，还有巨大的孤独感。敢死队，永泽, 直子和玲子以各种形式从自己的生活中走开，从渡边的角度来看，这些人就像都找到了自己的归宿一般，但渡边还停留在这里。这些在渡边生活中曾占据不少位置的人，离开后的空白对渡边一定能产生不小的影响。</p>
<p>如果小说的主人公换成敢死队，那么渡边就只是他一个周末外出打工赚生活费，不善交际的一个舍友罢了。生活中，我们身边类似这样不起眼的人物少吗？包括我们自己，没有广的交际圈子，上普普通通的学，过普普通通的生活，干普普通通的事情。渡边的孤独，如果换个角度来看也是很普通的，就在我们身边。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yixiang.pw/2014/10/02/OSX-VPN-Setup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="周意翔">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yixiang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2014/10/02/OSX-VPN-Setup/" itemprop="url">OSX VPN设置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-10-02T15:37:09+08:00">
                2014-10-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发/" itemprop="url" rel="index">
                    <span itemprop="name">开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>用L2TP/IPsec VPN服务访问外网查资料，老有几个麻烦问题：</p>
<ol>
<li>在系统偏好设置中勾选“Send all traffic over VPN connection”之后，所有流量走VPN连接，一方面国内部分网站速度比较慢，另外访问有一些比较重要的网站时，心里也有些担心。</li>
<li>我使用的VPN服务，每次连接上之后都会动态地配置DNS为Google的服务器，因为国内DNS污染的问题，这个设置虽然必要，但有时也需要修改。通过系统偏好手动修的设置，总会在断开VPN之后丢失，每次修改很麻烦。</li>
<li>我用的联通网络，动态配置的DNS很垃圾，通过系统偏好设置的DNS，在连接过VPN之后也会丢失，重新配置成那个垃圾DNS。</li>
</ol>
<p>在Linux和一些Unix系统下，通过设置/etc/resolv.conf能够对DNS配置，但OSX上这个文件是由系统动态生成的，OSX的系统配置文件可以通过scutil进行管理，配置文件位置为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/Library/Preferences/SystemConfiguration/preferences.plist</div></pre></td></tr></table></figure>
<p>根据配置文件中的配置项来看，每个接口都有一个配置项，位于ROOT/NetworkServices下面。每个Network Service都有一个以UUID为key的配置项，每个Network Service都有一个UserDefinedName。在我的电脑上，可以看到这些用户定义名称包括：Wi-Fi，Bluetooth PAN, VPN (L2TP over IPsec), … 参考这些配置的命名，这里将VPN的配置称为VPN Network Service配置，将电脑上默认的连接配置称为Primary Network Service配置。</p>
<h1 id="VPN-Network-Service国内外流量自动切换"><a href="#VPN-Network-Service国内外流量自动切换" class="headerlink" title="VPN Network Service国内外流量自动切换"></a>VPN Network Service国内外流量自动切换</h1><p>OSX在建立ppp连接之后，会调用/etc/ppp/ip-up脚本，断开ppp连接之后会调用/etc/ppp/ip-down脚本，Linux也有同样地机制。因为L2TP/IPsec的隧道里面走ppp协议，因此这种类型的VPN连接建立之后，也会调用相应的脚本。我们可以利用这个脚本做一些处理，自动地让国内的流量走原来的连接，国外的流量走VPN。 我们只需要修改路由表，让IP包根据不同的目的地址，选择是否走VPN接口即可。这个可以利用开源工具chnroutes根据这个地址的数据生成接生成ip-{up,down}两个脚本。可以看到脚本里面会自动添加针对中国IP地址的路由项，让访问中国IP地址的IP包绕过VPN。 将这两个脚本放到/etc/ppp/文件夹下即可。 在VPN连接前后，可以通过执行下面的命令，查看路由表的变动。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> netstat -rn</div></pre></td></tr></table></figure>
<h1 id="自动修改VPN-Network-Service-DNS"><a href="#自动修改VPN-Network-Service-DNS" class="headerlink" title="自动修改VPN Network Service DNS"></a>自动修改VPN Network Service DNS</h1><p>正常情况下，大家应该用不上这个。VPN的DNS虽然可以直接通过“系统偏好设置”进行修改，但每次重新连接VPN之后修改便丢失了，很麻烦。可以利用ip-up脚本在每次连接VPN后自动配置DNS。 基本办法可以参考这篇文章和Comments的内容，主要利用osx的scutil工具进行配置。我对文章中的脚本做了简单的修改，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">SERVICES=$(scutil --nc list | grep 'Connected' | awk '&#123;print $3&#125;')</div><div class="line"> for SERVICE in $SERVICES</div><div class="line"> do</div><div class="line"> scutil &lt;&lt;&lt; "</div><div class="line"> d.init</div><div class="line"> get State:/Network/Service/$SERVICE/DNS</div><div class="line"> d.add ServerAddresses * 8.8.8.8 114.114.114.114</div><div class="line"> set State:/Network/Service/$SERVICE/DNS</div><div class="line"> quit</div><div class="line"> "</div><div class="line"> done</div></pre></td></tr></table></figure>
<p>将其添加到ip-up脚本底部即可。</p>
<h1 id="修改Primary-Network-Service-DNS"><a href="#修改Primary-Network-Service-DNS" class="headerlink" title="修改Primary Network Service DNS"></a>修改Primary Network Service DNS</h1><p>Primary Network Service按说应该和VPN没什么关系，但我在“系统偏好设置”中设置的DNS，总在使用VPN后丢失，因此又可以在ip-up和ip-down里面添加下面的脚本，保证在使用VPN前后，Primary Network Service的DNS总是自己想要的值，对于获取Primary Service的ID，参考了<a href="http://hints.macworld.com/article.php?story=20050621051643993" target="_blank" rel="external">这篇文章</a>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span>修改PIRMARY Network Service DNS</div><div class="line"> PRIMARY_SERVICE=$(scutil &lt;&lt;&lt; "</div><div class="line"> open</div><div class="line"> get State:/Network/Global/IPv4</div><div class="line"> d.show</div><div class="line"> quit</div><div class="line"> " | grep 'PrimaryService' | awk '&#123;print $3&#125;')</div><div class="line"> </div><div class="line"> scutil &lt;&lt;&lt; "</div><div class="line"> d.init</div><div class="line"> get State:/Network/Service/$PRIMARY_SERVICE/DNS</div><div class="line"> d.add ServerAddresses * 114.114.114.114 114.114.115.115</div><div class="line"> set State:/Network/Service/$PRIMARY_SERVICE/DNS</div><div class="line"> quit</div><div class="line"> "</div></pre></td></tr></table></figure>
<p>需要注意的是，如果在ip-up脚本中使用了设置VPN DNS的脚本，需要将VPN DNS修改的脚本放在修改Primary Service DNS的脚本之后执行。  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/avatar.jpg"
              alt="周意翔" />
          
            <p class="site-author-name" itemprop="name">周意翔</p>
            <p class="site-description motion-element" itemprop="description"></p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">周意翔</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
