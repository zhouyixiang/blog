---
title: TPC-C硬件性能估计
date: 2018-05-24 22:14:06
mathjax: true
tags: [tpc, tpmc, 软件项目]
---

> **注意：** 我在这块没有什么经验，因为项目原因在急切之下了解了一点相关内容，这篇文章只用来记录我看过这些资料后的初步理解。

给某公司做项目方案，对方要求添加硬件要求估计的部分，计算tpmC值。赶紧去了解了一下，这个是个比较老的概念了，网上能找到零几年的信息，不过这个对我来说是个新东西。搜索一番之后，发现国内网站上能找到的讨论比国外要多些。因为有时间要求，刚开始急着找了一些文章看了一下，感觉每个和每个说的都有点出入，干脆静下来从头梳理一下。

### TPC和tmpC是什么？

这个概念的出处来自[TPC非盈利组织](http://www.tpc.org)，这个组织定义了一些标准用来测试硬件性能。针对不同的场景定义了不同的标准，分别编号TPC-C, TPC-E, TPC-W等等。客户要求的我们给出的tmpC值，就是TPC-C测试对应的指标值。


TPC官网上有这些测试的规范，但我们没时间去看具体细节。搜到[HP的网站上一个关于TPC-C的概要介绍文档](ftp://ftp.hp.com/pub/c-products/servers/benchmarks/HP_ProLiant_tpcc_Overview.pdf)，简额明要，对于快速了解一下这个概念还挺有帮助。


> **Performance**
> tpmC (Transactions-per-Minute-C): This is the average number of new-order transactions that the system processes per minute over a minimum of a two hour period. It is important to note that only the new-order transactions (~45% of the transactions) are counted in the tpmC metric. 

> **Price/Performance**
> $/tpmC: With every TPC-C benchmark summary there is an itemized price-sheet of all of the commercial hardware and software components of the OLTP system, including 3 years’ worth of 24x7/4-hour response time support. Price/performance is represented by the sum of this hardware, software and support pricing divided by the tpmC rate.

> **System components stressed**
> The TPC-C benchmark stresses most components of the database server system and is very sensitive to latency. CPU bandwidth and speed are major factors in TPC-C performance, along with the speed of the underlying system chipset. The database tables and indices benefit from large system memory (RAM) and processor cache as these components work together to reduce the latency required to fetch data for the processors. Disk I/O latency is paramount to TPC-C performance, as it is in many OLTP applications. This results in database systems attached to hundreds, sometimes thousands of disks above and beyond space requirements to reduce disk latency for random disk I/Os

> **Conclusion**
> The TPC-C benchmark is an ideal benchmark for measuring system OLTP performance. Simple metrics and an easily understandable workload using only 5 transactions and 9 database tables make it easy to use the TPC-C benchmark to compare systems, platforms, DBMS systems and Operating Systems. Benchmark results are audited by a third party to insure compliance with the TPC-C specification and are further reviewed by the Transaction Processing Performance Council. The TPC-C benchmark has a scalable workload from 1 processor to above 64 processors, making it the industry standard benchmark to measure system OLTP performance.


上面是从文档中摘抄的几个片段，关键点：tpmC值的意义，TPC-C基准测试测试的是系统的那些部分。

### tpmC值从哪里来？

按照上面的信息，tpmC值应该是在TPC-C测试下测出来的值，客户要我们给出tpmC值预估该怎么预估，预估值干什么用？

### 预估值干什么用?

tpc的网站上可以查询到一些设备经过测试后的tpmC值，如果我们能给系统预估一个比较准确的tpmC值，那么这个系统需要的硬件参数就能通过对比查找，找到一个合适的参考了，这样有个相对的参考，比拍脑袋要靠谱点，心里踏实些对吧。

### 那么如何预估呢？

根据tpmC值的定义，我们需要预估系统在每分钟内能够处理的“*新订单(new-order)*”事务数。这里“*新订单*”是以TPC-C规范里面定义的测试场景来说的，在这个标准场景里面，系统在处理新订单的同时，也在处理其它几种类型的事务。总之，我们要对某个系统的tpmC值进行预估，也就是预估这个系统在每分钟内能够处理的事务数。

### 具体的例子

具体例子中文资料比较好找，估计国内很多软件项目方案要求写这块内容。[这里有一篇文章内容相对比较丰富](https://www.jianshu.com/p/5589e4a8765c)，看内容估计是从用友流传出来的。这篇文章的内容结构对不熟悉如何写售前硬件方案的人来说是比较有参考作用的。在文章中，预估的tpmC值被用来估计数据库服务器的CPU需求，应用服务器的CPU需求则基于数据库服务器做了个估计，另外还单独写了网络、内存方面的估计方法。

文章中提到一个公式：

$$ TPM = TASK \\times 80\\% \\times S \\times F / \(T \\times C\) $$

其中：
* **TASK**：为每日业务统计峰值交易量
* **T**：为每日峰值交易时间，假设每日80%交易量集中在每天的3小时，即180分钟内完成：T=180。
* **S**：为业务操作相对于标准TPC-C测试基准环境交易的复杂程度比例。由于实际的业务的复杂程度与TPC‑C标准测试中的交易存在较大的差异，根据实践用户的统计结果，每笔交易操作相比较于TPC标准测试中的每笔交易的复杂度此值可设定为20~40。
* **C**：为主机CPU处理余量。实际应用经验表明，一台主机服务器的CPU利用率高于80%则表明CPU的利用率过高会产生系统瓶颈，而利用率处于60%时，是处于利用率最佳状态。因此，在推算主机性能指标时，必须考虑CPU的冗余，设定C=60%。
* **F**：为系统未来3-5年的业务量发展冗余预留。

可以看到，这个公式里面$TASK\\times80\%$的部分应该是计算峰值交易时间内的交易量的；S和F只是两个经验值，用于两个不同方面的估计；T是峰值交易时间的分钟数，这样算出来的结果就是每分钟的数量；C是CPU余量，是假设CPU不能100%使用，那么系统必须要能够处理更多交易量才行。

整个公式的概念还是清晰的，和tpmC的定义也能匹配上，其中$80\%$这个量可以根据不同系统特点自己定义。总而言之，就是根据经验数据也好，还是瞎估计也好，先估计出来你的系统高峰使用时间长度，以及这个时间段内的事务数，然后这两个数可以计算出来每分钟事务数。然后根据你的系统相对TCP-C标准测试的复杂度，你想要CPU工作负荷和未来业务可能的增长情况，对这个事务数做一些放大。

网上还能搜到一些文章的公式具体形式和这个可能不太一样，不过基本原理是一致的。不过看到有些文章的案例写得不符合原理，估计是为了交差随便应付着凑出来的吧:)

[TPC网站上有官方认可的测试结果可查](http://www.tpc.org/tpcc/results/tpcc_results.asp?print=true&orderby=tpm&sortby=desc)，不过看最新的结果在2013年，估计近年大家已经不太看重这个了？或者只是不注重TPC-C类型的测试了而已？这个东西虽然只是个参考，离实际情况应该还有很大差距，不过总归比拍脑袋感觉要那么靠谱一丢丢。