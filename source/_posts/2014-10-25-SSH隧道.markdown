---
layout: post
title:  "SSH隧道"
date:   2014-10-25 09:56:56 +0000
categories: 开发
tags: [开发环境]
---

有时我们希望能够让别人能够远程访问在我们内网里面的某个网络服务。 例如在Web开发时，我们做了一些功能之后，希望让客户先看看，如果客户在很远的地方，那么我们只能将Web应用先部署到公网上，然后让他访问。

部署Web应用有时候是一件麻烦的事情：需要配置Web Server，数据库等等相关的组件，有时会很多。

或者又例如，你基于某个平台的API进行开发测试，比如alipay的API，或者微信API。这些平台需要把请求发送到由你指定的URL，当然这些URL必须是公网的。但如果总是将代码部署到公网服务器上再进行测试，效率非常低。

# SSH Tunnel Port Forwarding 

有一个依赖SSH隧道的解决办法，前提需要你有一台公网上的服务器，并且服务器能够通过SSH连接。 

假如我们有下面这样的需求： 一个开发者在家里进行网站开发，他的同事在公司里面想看看他的进展，公司在公网上有一台服务器。开发者当然可以将应用部署到服务器上让同事看，不过我们有更简单地办法。

图片

如果开发者的Web应用在自己开发及其上监听8000端口，他可以使用下面的命令（前提需要开启SSH的相应功能，可参考文末链接进行设置）：

```shell
ssh -v -R 0.0.0.0:public_server_port:0.0.0.0:8000 username@server
```

这样便建立了一条开发者机器到公网Server的一条SSH隧道，并将对公网server public_server_port的访问转发到开发者机器的8000端口。之后，他的同事在公司里面直接用浏览器访问公网Server上的这个端口就行了。是不是很方便？ 

# Linux Firewall Settings 

正常情况下，可能还需要对防火墙进行一些额外设置，毕竟我们在Server上开了一个新的端口。 使用CentOS 6.5作为中间服务器设置过程 

1. 打开CentOS 6.5 SSH配置文件中的/etc/ssh/sshd_config GatewayPort选项。 

2. 重启ssh服务
``` shell
service sshd restart
```

3. 选择centos 6.5上使用的端口，例如8999，需要开启8999端口的防火墙设置

``` shell
iptables --line -vnL
#index的值根据iptables --line -vnL的输出确定
iptables -I INPUT index -p tcp --dport 8999 -m state --state NEW,ESTABLISHED -j ACCEPT
```

4. 保存防火墙设置并重启防火墙

``` shell
service iptables save
service iptables restart
```

如需删除某条规则：

``` shell
iptables -D INPUT index
```

5. 在local环境下，使用SSH建立tunnel

``` shell
ssh -v -R 0.0.0.0:8999:0.0.0.0:8000 username@server
```

6. Done 

# 参考 

* SSH tunnel

    *  http://blog.trackets.com/2014/05/17/ssh-tunnel-local-and-remote-port-forwarding-explained-with-examples.html

    * http://www.noah.org/wiki/SSH_tunnel 

* Iptables设置 

    * http://www.binarytides.com/open-http-port-iptables-centos/
